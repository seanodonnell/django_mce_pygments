<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
{% load staticfiles %}
<head>
    <title>Pygments</title>
    <link rel="stylesheet" href="{% static "css/pygmentsplugin.css" %}">
    <script type="text/javascript" src="{% static "grappelli/tinymce/jscripts/tiny_mce/tiny_mce_popup.js" %}"></script>
<script src="{% static "mezzanine/js/"|add:settings.JQUERY_FILENAME %}"></script>
    <script type="text/javascript">

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(
                        cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    tinyMCEPopup.requireLangPack();

    var ExampleDialog = {
        init : function() {
            var f = document.forms[0];
            // Get the selected contents as text and place it in the input
            f.code.value = tinyMCEPopup.editor.selection.getContent(
                                                         {format : 'text'});
            },

        insert : function() {

            var csrftoken = getCookie('csrftoken');
            // Insert the contents from the input into the document
            $.post(".", { lang: $('#lang').val(),code: $('#code').val(),
                                   style: $('#style').val(),
                                   csrfmiddlewaretoken:  csrftoken},
            function(data) {
                $('#code').val(data);
                tinyMCEPopup.editor.execCommand('mceInsertContent',
                                     false, document.forms[0].code.value);
                tinyMCEPopup.close();      
            });
        },

        view_code : function() {
		$('#previewtab').hide();
		$('#codetab').show();

	},
	preview : function() {
		$('#codetab').hide();
		$('#previewtab').show();
                var csrftoken = getCookie('csrftoken');
		var req_data = {lang: $('#lang').val(),code: $('#code').val(),
                                   style: $('#style').val(),
                                   csrfmiddlewaretoken:  csrftoken};
                $.ajax({
			url:'{% url 'pygments' %}',
			type:'POST',
			data : req_data,
		}).done(function(msg)
		{
			$('#previewcontent').html(msg);
		});

	}
    };

    tinyMCEPopup.onInit.add(ExampleDialog.init, ExampleDialog);

    </script>
</head>
<body>

    <form id="pygments_form" method="POST" action="{% url 'pygments' %}">
        {% csrf_token %}
        <div id="langcontrol" class="control">
            <span class="controllabel"><label>Language:</label></span>
            <select id="lang" name="lang" type="text" class="text">
		{% for lang in langs %}
                <option value="{{ lang.1 }}" >{{ lang.0 }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="stylecontrol" class="control">
            <span class="controllabel"><label>Style:</label></span>
            <select id="style" name="style" type="text" class="text">
                {% for style in styles %}
		<option value="{{ style }}">{{style}}</option>
                {% endfor %}
            </select>
        </div>

                <input type="button" id="view_code" name="view_code" value="Code" onclick="ExampleDialog.view_code();" />
                <input type="button" id="preview" name="preview" value="Preview" onclick="ExampleDialog.preview();" />
        <div id="tab-container" class="tab-container">
	        <div id="codetab">
                    <p><textarea id="code" name="code" cols="80" rows="10"></textarea></p>
	        </div>
	        <div id="previewtab" style="display:none">
	            <p>Preview</p>
		    <div id="previewcontent">

		    </div>
	        </div>
	</div>
        <p id="result"></p>
        <div class="mceActionPanel">
            <div style="float: left">
                <input type="button" id="insert" name="insert" value="{#insert}" onclick="ExampleDialog.insert();" />
            </div>

            <div style="float: right">
                <input type="button" id="cancel" name="cancel" value="{#cancel}" onclick="tinyMCEPopup.close();" />
            </div>
        </div>
    </form>

</body>
</html>
